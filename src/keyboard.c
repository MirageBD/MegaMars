#include <stdint.h>
#include "keyboard.h"
#include "registers.h"
#include "modplay.h"
#include "macros.h"

/*
	KEYBOARD MATRIX

			0        1        2         3       4         5       6        7        8
	+---+--------+--------+--------+--------+--------+--------+--------+--------+--------+
	| 0 | INST   | 3      | 5      | 7      | 9      | +      | £      | 1      | NO     |
	|   | DEL    |        |        |        |        |        |        |        | SCROLL |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+--------+
	| 1 | RETURN | W      | R      | Y      | I      | P      | *      | ←      | TAB    |
	|   |        |        |        |        |        |        |        |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+--------+
	| 2 | →      | A      | D      | G      | J      | L      | ;      | CTRL   | ALT    |
	|   |        |        |        |        |        |        |        |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+--------+
	| 3 | F7     | 4      | 6      | 8      | 0      | -      | CLR    | 2      | HELP   |
	|   |        |        |        |        |        |        | HOME   |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+--------+
	| 4 | F1     | Z      | C      | B      | M      | .      | SHIFT  | SPC    | F9     |
	|   |        |        |        |        |        |        | right  |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+--------+
	| 5 | F3     | S      | F      | H      | K      | :      | =      | MEGA   | F11    |
	|   |        |        |        |        |        |        |        |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+--------+
	| 6 | F5     | E      | T      | U      | O      | @      | ↑      | Q      | F13    |
	|   |        |        |        |        |        |        |        |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+--------+
	| 7 | ↓      | SHIFT  | X      | V      | N      | ,      | /      | RUN    | ESC    |
	|   |        | left   |        |        |        |        |        | STOP   |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+--------+

	; row/columns inverted

			0        1        2         3       4         5       6        7
	+---+--------+--------+--------+--------+--------+--------+--------+--------+
	| 0 | INST   | RETURN | CURS → | F7     | F1     | F3     | F5     | CURS ↓ |
	|   | DEL    |        |        |        |        |        |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+
	| 1 | 3      | W      | A      | 4      | Z      | S      | E      | SHIFT  |
	|   |        |        |        |        |        |        |        | left   |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+
	| 2 | 5      | R      | D      | 6      | C      | F      | T      | X      |
	|   |        |        |        |        |        |        |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+
	| 3 | 7      | Y      | G      | 8      | B      | H      | U      | V      |
	|   |        |        |        |        |        |        |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+
	| 4 | 9      | I      | J      | 0      | M      | K      | O      | N      |
	|   |        |        |        |        |        |        |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+
	| 5 | +      | P      | L      | -      | .      | :      | @      | ,      |
	|   |        |        |        |        |        |        |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+
	| 6 | £      | *      | ;      | CLR    | SHIFT  | =      | ↑      | /      |
	|   |        |        |        | HOME   | right  |        |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+
	| 7 | 1      | ←      | CTRL   | 2      | SPC    | MEGA   | Q      | RUN    |
	|   |        |        |        |        |        |        |        | STOP   |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+
	| 8 | NO     | TAB    | ALT    | HELP   | F9     | F11    | F13    | ESC    |
	|   | SCROLL |        |        |        |        |        |        |        |
	+---+--------+--------+--------+--------+--------+--------+--------+--------+
*/

uint8_t keyboard_pressed = 0xff;
uint8_t keyboard_prevpressed = 0xff;

/*
uint8_t keyboard_toascii[] =
{
//   0   1   2   3   4   5   6   7
	 0,  0,  0,  0,  0,  0,  0,  0, // 0
	51, 23,  1, 52, 26, 19,  5,  0, // 1
	53, 18,  4, 54,  3,  6, 20, 24, // 2
	55, 25,  7, 56,  2,  8, 21, 22, // 3
	57,  9, 10, 48, 13, 11, 15, 14, // 4
	 0, 16, 12,  0,  0,  0,  0,  0, // 5
	 0,  0,  0,  0,  0,  0,  0,  0, // 6
	49,  0,  0, 50, 32,  0, 17,  0, // 7
	 0,  0,  0,  0,  0,  0,  0,  0, // 8

	 0,  0,  0,  0,  0,  0,  0,  0, // 9
};
*/

void keyboard_update()
{
	keyboard_prevpressed = keyboard_pressed;

	keyboard_pressed = 0xff;
	for(int column = 0; column < 9; column++)
	{
		IO.KEYMATRIXSEL = column;
		uint8_t keys = IO.KEYMATRIXPEEK ^ 0xff;

		for(int row = 0; row < 9; row++)
		{
			if((keys & 0x01) == 0x01)
			{
				keyboard_pressed = row + (column << 3);
			}
			keys >>= 1;
		}
	}

	if(IO.KEYUP == 1)
		keyboard_pressed = KEYBOARD_CURSORUP;
	if(IO.KEYLEFT == 1)
		keyboard_pressed = KEYBOARD_CURSORLEFT;
}

uint8_t keyboard_keyreleased(uint8_t key)
{
	if(keyboard_pressed == 0xff) // no key pressed
	{
		if(keyboard_prevpressed != 0xff) // but there was one previously
			if(keyboard_prevpressed == key)
				return 1;
	}
	return 0;
}

uint8_t keyboard_anykeyreleased()
{
	if(keyboard_pressed == 0xff) // no key pressed
	{
		if(keyboard_prevpressed != 0xff) // but there was one previously
			return 1;
	}
	return 0;
}

uint8_t keyboard_keypressed(uint8_t key)
{
	if(keyboard_pressed == key)
		return 1;

	return 0;
}
